name: Publish to PyPI

on:
  release:
    types: [published]
  pull_request:
    paths:
      - 'pyproject.toml'
      - 'web_hacker/**'
      - '.github/workflows/publish.yml'
  workflow_dispatch:

jobs:
  # -------------------------
  # PR + Release: build & test
  # -------------------------
  build:
    name: Build & test wheel
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build deps
        run: |
          python -m pip install --upgrade pip
          pip install build hatchling uv

      - name: Build package
        run: python -m build

      - name: Extract version
        id: get-version
        run: |
          VERSION=$(ls dist/*.whl | sed 's/.*web_hacker-\(.*\)-py3.*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ---------------------------------
      # 1️⃣ Basic sanity: local install
      # ---------------------------------
      - name: Verify wheel installs locally
        run: |
          python -m venv /tmp/local-venv
          source /tmp/local-venv/bin/activate
          pip install dist/*.whl
          python -c "import web_hacker"

      # ---------------------------------
      # 2️⃣ STRICT: deps from TestPyPI ONLY
      # ---------------------------------
      - name: Resolve deps via TestPyPI only (strict)
        run: |
          set -e
          python -m venv /tmp/testpypi-strict
          source /tmp/testpypi-strict/bin/activate
          pip install --upgrade pip uv

          echo "Strict TestPyPI dependency resolution (expected to fail if deps are missing)"
          uv pip install \
            --index-url https://test.pypi.org/simple/ \
            dist/*.whl

          python -c "import web_hacker"

      # ---------------------------------
      # 3️⃣ REALISTIC: TestPyPI preferred,
      #    PyPI fallback (release mirror)
      # ---------------------------------
      - name: Resolve deps (TestPyPI preferred, PyPI fallback)
        run: |
          python -m venv /tmp/testpypi-real
          source /tmp/testpypi-real/bin/activate
          pip install --upgrade pip uv

          uv pip install \
            --index-url https://test.pypi.org/simple/ \
            --extra-index-url https://pypi.org/simple/ \
            --index-strategy unsafe-first-match \
            dist/*.whl

          python -c "import web_hacker"

      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  # -------------------------
  # Release only: TestPyPI
  # -------------------------
  publish-testpypi:
    name: Publish to TestPyPI
    if: github.event_name == 'release'
    needs: build
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    outputs:
      test_version: ${{ steps.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build deps
        run: |
          python -m pip install --upgrade pip
          pip install build hatchling

      - name: Add dev suffix for TestPyPI
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          VERSION=$(python - <<'PY'
          import tomllib
          print(tomllib.load(open("pyproject.toml","rb"))["project"]["version"])
          PY
          )
          DEV_VERSION="${VERSION}.dev${TIMESTAMP}"
          sed -i "s/version = \"$VERSION\"/version = \"$DEV_VERSION\"/" pyproject.toml
          echo "DEV_VERSION=$DEV_VERSION" >> $GITHUB_ENV

      - name: Clean dist
        run: rm -rf dist

      - name: Build TestPyPI artifacts
        run: python -m build

      - name: Extract TestPyPI version
        id: get-version
        run: |
          VERSION=$(ls dist/*.whl | sed 's/.*web_hacker-\(.*\)-py3.*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

  test-install-testpypi:
    name: Verify install from TestPyPI
    if: github.event_name == 'release'
    needs: publish-testpypi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Install exact TestPyPI version
        run: |
          VERSION="${{ needs.publish-testpypi.outputs.test_version }}"
          for i in {1..10}; do
            if uv pip install --system --pre \
              --index-url https://test.pypi.org/simple/ \
              --no-extra-index \
              "web-hacker==$VERSION"; then
              python -c "import web_hacker"
              exit 0
            fi
            sleep 30
          done
          exit 1

  # -------------------------
  # Release only: PyPI
  # -------------------------
  publish-pypi:
    name: Publish to PyPI
    if: github.event_name == 'release'
    needs: test-install-testpypi
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - uses: pypa/gh-action-pypi-publish@release/v1

  test-install-pypi:
    name: Verify install from PyPI
    if: github.event_name == 'release'
    needs: publish-pypi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Install from PyPI
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          for i in {1..10}; do
            if uv pip install --system "web-hacker==$VERSION"; then
              python -c "import web_hacker"
              exit 0
            fi
            sleep 30
          done
          exit 1
